#include <GyverOLED.h>
#include <Wire.h>
#include "GyverOLEDMenu.h"
#include "cart.h"
#include "encoder.h"
#include "rgb.h"
#include "sensor.h"
#include "marker.h"

int offset = 0;
Sensor sensor;
GyverOLED<SSD1306_128x64> oled;
Encoder enc(10, 11, 12);
cart IvanTM(1, 2, 4, 3, 5);
rgb<8, 3> fara(3, 100);
marker black(9, 90, 270, IvanTM);
Sensor tcrt(A1);
OledMenu<6, GyverOLED<SSD1306_128x64>> menu(&oled);
int gray;
static const unsigned char PROGMEM image_Connect_me_bits[] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xff,0xff,0xfc,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xff,0xff,0xfc,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0f,0x00,0x00,0x03,0xc0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0f,0x00,0x00,0x03,0xc0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xf0,0x00,0x00,0x00,0x3c,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xf0,0x00,0x00,0x00,0x3c,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x00,0x00,0x00,0x00,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x00,0x00,0x00,0x00,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0c,0x00,0x00,0x00,0x00,0x00,0xc0,0x00,0x00,0x00,0x00,0x0f,0xfc,0x00,0x00,0x00,0x0c,0x00,0x00,0x00,0x00,0x00,0xc0,0x00,0x00,0x00,0x00,0x0f,0xfc,0x00,0x00,0x00,0x30,0x00,0x00,0x00,0x00,0x00,0x30,0x00,0x00,0x00,0x00,0x0c,0x0c,0x00,0x00,0x00,0x30,0x00,0x00,0x00,0x00,0x00,0x30,0x00,0x00,0x00,0x00,0x0c,0x0c,0x00,0x00,0x00,0xc0,0x00,0x00,0x00,0x00,0x00,0x30,0x00,0x00,0x00,0x00,0x0f,0x3c,0x00,0x00,0x00,0xc0,0x00,0x00,0x00,0x00,0x00,0x30,0x00,0x00,0x00,0x00,0x0f,0x3c,0x00,0x00,0x00,0xc0,0x00,0x00,0x00,0x00,0x00,0x0c,0x00,0x00,0x00,0x00,0x0c,0x0c,0x00,0x00,0x00,0xc0,0x00,0x00,0x00,0x00,0x00,0x0c,0x00,0x00,0x00,0x00,0x0c,0x0c,0x00,0x00,0x03,0x00,0x00,0xff,0x00,0x00,0x00,0x0c,0x03,0xfc,0x00,0x00,0x0f,0xfc,0x00,0x00,0x03,0x00,0x00,0xff,0x00,0x00,0x00,0x0c,0x03,0xfc,0x00,0x00,0x0f,0xfc,0x00,0x00,0x03,0x00,0x03,0x00,0xc0,0x00,0x00,0x03,0x3c,0x03,0x00,0x00,0x30,0x03,0x00,0x00,0x03,0x00,0x03,0x00,0xc0,0x00,0x00,0x03,0x3c,0x03,0x00,0x00,0x30,0x03,0x00,0x00,0x0c,0x00,0x0c,0xff,0x30,0x00,0x00,0x03,0xc0,0x00,0xc0,0x00,0x30,0x03,0x00,0x00,0x0c,0x00,0x0c,0xff,0x30,0x00,0x00,0x03,0xc0,0x00,0xc0,0x00,0x30,0x03,0x00,0x00,0x0c,0x00,0x33,0xf3,0xcc,0x00,0x00,0x3c,0x00,0x00,0xc0,0x00,0x30,0x03,0x00,0x00,0x0c,0x00,0x33,0xf3,0xcc,0x00,0x00,0x3c,0x00,0x00,0xc0,0x00,0x30,0x03,0x00,0x00,0x0c,0x00,0x33,0xf0,0xcc,0x00,0x03,0xc0,0x00,0x3f,0xc0,0x00,0x30,0x03,0x00,0x00,0x0c,0x00,0x33,0xf0,0xcc,0x00,0x03,0xc0,0x00,0x3f,0xc0,0x00,0x30,0x03,0x00,0x00,0x0c,0x00,0x33,0xff,0xcc,0x00,0x3c,0x00,0x03,0xff,0x00,0x00,0x30,0x03,0x00,0x00,0x0c,0x00,0x33,0xff,0xcc,0x00,0x3c,0x00,0x03,0xff,0x00,0x00,0x30,0x03,0x00,0x00,0x30,0x00,0x33,0xff,0xcc,0x00,0x00,0x00,0x0f,0xfc,0x00,0x00,0x30,0x03,0x00,0x00,0x30,0x00,0x33,0xff,0xcc,0x00,0x00,0x00,0x0f,0xfc,0x00,0x00,0x30,0x03,0x00,0x00,0x30,0x00,0x0c,0xff,0xf0,0x00,0x00,0x00,0xff,0xf0,0x00,0x00,0x30,0x03,0x00,0x00,0x30,0x00,0x0c,0xff,0xf0,0x00,0x00,0x00,0xff,0xf0,0x00,0x00,0x30,0x03,0x00,0x00,0x30,0x00,0x03,0x30,0x0c,0x00,0x00,0x03,0xff,0xc0,0x00,0x00,0x3f,0xff,0x00,0x00,0x30,0x00,0x03,0x30,0x0c,0x00,0x00,0x03,0xff,0xc0,0x00,0x00,0x3f,0xff,0x00,0x00,0x30,0x00,0x00,0xc0,0x00,0x00,0x00,0x0f,0xff,0x00,0x00,0x00,0x03,0x30,0x00,0x00,0x30,0x00,0x00,0xc0,0x00,0x00,0x00,0x0f,0xff,0x00,0x00,0x00,0x03,0x30,0x00,0x00,0x30,0x00,0x00,0xc0,0x00,0x00,0x00,0x3f,0xfc,0x00,0x00,0x00,0x03,0x30,0x00,0x00,0x30,0x00,0x00,0xc0,0x00,0x00,0x00,0x3f,0xfc,0x00,0x00,0x00,0x03,0x30,0x00,0x00,0x30,0x00,0x00,0x00,0x00,0x00,0x00,0xff,0xf0,0x00,0x00,0x00,0x03,0x30,0x00,0x00,0x30,0x00,0x00,0x00,0x00,0x00,0x00,0xff,0xf0,0x00,0x00,0x00,0x03,0x30,0x00,0x00,0x30,0x00,0x00,0x00,0x30,0x00,0x0f,0x00,0xff,0xff,0x00,0x00,0x03,0xf0,0x00,0x00,0x30,0x00,0x00,0x00,0x30,0x00,0x0f,0x00,0xff,0xff,0x00,0x00,0x03,0xf0,0x00,0x00,0x30,0x00,0x00,0x00,0x0f,0x00,0xf0,0x00,0x0f,0xf0,0xc0,0x00,0x00,0xc0,0x00,0x00,0x30,0x00,0x00,0x00,0x0f,0x00,0xf0,0x00,0x0f,0xf0,0xc0,0x00,0x00,0xc0,0x00,0x00,0x30,0x00,0x00,0x00,0x00,0xff,0xff,0xff,0xf0,0x00,0xc0,0x00,0x03,0xff,0x00,0x00,0x30,0x00,0x00,0x00,0x00,0xff,0xff,0xff,0xf0,0x00,0xc0,0x00,0x03,0xff,0x00,0x00,0x30,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xc0,0x00,0x0c,0x00,0xf0,0x00,0x30,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xc0,0x00,0x0c,0x00,0xf0,0x00,0x30,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x00,0x00,0x30,0x00,0x0c,0x00,0x30,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x00,0x00,0x30,0x00,0x0c,0x00,0x30,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xfc,0x00,0x00,0x30,0x00,0x03,0x00,0x30,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xfc,0x00,0x00,0x30,0x00,0x03,0x00,0x30,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0f,0x00,0x00,0x00,0x30,0x00,0x00,0xc0,0x30,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0f,0x00,0x00,0x00,0x30,0x00,0x00,0xc0,0x30,0x00,0x00,0x00,0x00,0x00,0x3f,0xff,0xf0,0x00,0x00,0x00,0x0f,0x00,0x00,0xc0,0x30,0x00,0x00,0x00,0x00,0x00,0x3f,0xff,0xf0,0x00,0x00,0x00,0x0f,0x00,0x00,0xc0,0x30,0x00,0x00,0x00,0x00,0x00,0x03,0xff,0xc0,0x00,0x00,0x00,0x00,0xc0,0x00,0x30,0x30,0x00,0x00,0x00,0x00,0x00,0x03,0xff,0xc0,0x00,0x00,0x00,0x00,0xc0,0x00,0x30,0x30,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xc0,0x00,0x00,0x00,0x00,0xf0,0x00,0x30,0x30,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xc0,0x00,0x00,0x00,0x00,0xf0,0x00,0x30};



void blackline(){
   IvanTM.setPos(0);
  while (true) {
    int sen = analogRead(A1);
    // Serial.println(analogRead(A1));

    if (sen < gray) {
      IvanTM.tick();
      // Serial.println(IvanTM.getPos());

    } else {
      Serial.println(analogRead(A1));

      break;
    }
    //  Serial.print("pos=");
    // Serial.println(IvanTM.getPos());
  }
  Serial.println("Start to doinf smth");
  Serial.print("Pos = ");
  Serial.println(IvanTM.getPos());
  IvanTM.gotoPos(IvanTM.getPos() - 49);
  IvanTM.setZero();
  IvanTM.gotoPos(-60);
}
void func1() {
  oled.clear();

  oled.update();
  fara.green();
 for(int i = 0;  i< 10; i++){
  fara.white();
  IvanTM.gotoPos(i*10);
  fara.yellow();
  black.down();
  delay(500);
  black.up();

 }
IvanTM.gotoPos(-60);
  oled.setScale(1);
  fara.clear();
  menu.showMenu(true);
  oled.update();
}

void func2() {
  IvanTM.gotoPos(0);
  black.down();
  black.up();
IvanTM.gotoPos(100);
black.down();
black.up();
}

void func3() {
  black.down();
}

void func4() {
  black.up();
}

void func5() {
  black.up();
  int bl= analogRead(A1), wl=analogRead(A1);
  IvanTM.setPos(100);
  while (IvanTM.tick()) {
    int sen = analogRead(A1);
    if (sen > bl)
      bl = sen;

    if (sen < wl)
      wl = sen;
  }
  gray = (bl + wl) / 6;

  Serial.print("GRAY=");
  Serial.println(gray);
 blackline();
}

void func6() {
  for(int i = 0; i<10; i+=2){
  black.drawLine(i*10, (i+1)*10);
}}
void func7(){}
void (*menuFuncs[7])() = { func1, func2, func3, func4, func5, func6, func7 };

const char* menuNames[6] = {
  "1", "2", "donw",
  "up", "calibr", "6"
};

// Колбэк при выборе пункта меню
void onItemChange(const int index, const void* val, const byte valType) {  //чтобы просто прокрутка не вызывала функцию, а именно тык по ней
  if (valType == VAL_ACTION) {
    if (index >= 0 && index < 7) {
      Serial.println(index);
      menuFuncs[index]();  // указатель вызывает функцию
    }
  }
}

void encoderCallback() {
  if (enc.dir != 0) {
    if (enc.dir == 1) {
      menu.selectNext(false);  //false значит без скипов элементов
    } else {
      menu.selectPrev(false);
    }
    oled.update();
  }

  if (enc.clicked) {
    menu.toggleChangeSelected();
    oled.update();
  }
}

void setup() {
  oled.init();
  Wire.setClock(400000L);
  oled.clear();
  oled.update();
  Serial.begin(9600);
  black.begin();
  
oled.drawBitmap(0, 0, image_Connect_me_bits, 124, 62, 1);

oled.update();
delay(1200);
  menu.onChange(onItemChange, false);

  menu.addItem(PSTR("1"));
  menu.addItem(PSTR("2"));
  menu.addItem(PSTR("DOwn"));
  menu.addItem(PSTR("Up"));
  menu.addItem(PSTR("calibrovka"));
  menu.addItem(PSTR("6"));
  menu.addItem(PSTR("7"));

  menu.showMenu(true);
  fara.begin();
  Serial.println("inited");

  while (enc.clicked) { enc.tick(); }
}

void loop() {
  enc.tick();
  encoderCallback();
  sensor.tick();
  IvanTM.tick();
}
